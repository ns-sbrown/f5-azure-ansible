---

- name: Create Demo VIP, pool and policy
  hosts: f5demo.eastus.cloudapp.azure.com
  connection: local

  tasks:
   - name: Create pool
     bigip_pool:  
       user: "f5admin"
       password: "ChangeMeNow!!!"
       server: f5demo.eastus.cloudapp.azure.com
       validate_certs: "no"
       name: "web_pool"
       monitor_type: "and_list"
       monitors: "http"
     delegate_to: localhost
   
   - name: Add Node 
     bigip_node:  
       user: "f5admin"
       password: "ChangeMeNow!!!"
       server: f5demo.eastus.cloudapp.azure.com
       validate_certs: "no"
       fqdn: "f5-web-app-demo.azurewebsites.net"
       name: "f5-web-app-demo.azurewebsites.net"
     delegate_to: localhost

   - name: Add member to pool
     uri:
       url: "https://f5demo.eastus.cloudapp.azure.com/mgmt/tm/ltm/pool/web_pool/members"
       method: "POST"
       validate_certs: no
       user: "f5admin"
       password: "ChangeMeNow!!!"
       force_basic_auth: yes
       body_format: "json"
       body:
         name: "f5-web-app-demo.azurewebsites.net:80"
     delegate_to: localhost
   
     tasks:
   - name: Create policy
     bigip_command:  
       user: "f5admin"
       password: "ChangeMeNow!!!"
       server: f5demo.eastus.cloudapp.azure.com
       validate_certs: "no"
       commands: create ltm policy /Common/Drafts/web-policy strategy first-match rules add { 1 { actions add { 1 { http-host replace value "f5-web-app-demo.azurewebsites.net" } } } }
     delegate_to: localhost
   
   - name: Publish Policy 
     bigip_command:
       user: "f5admin"
       password: "ChangeMeNow!!!"
       server: f5demo.eastus.cloudapp.azure.com
       validate_certs: "no"
       commands: publish ltm policy Drafts/web-policy
     delegate_to: localhost

   - name: Add VS
     bigip_virtual_server:
       user: "f5admin"
       password: "ChangeMeNow!!!"
       server: f5demo.eastus.cloudapp.azure.com
       validate_certs: "no"
       name: "web_vip"
       destination: "10.100.2.10"
       port: "443"
       snat: "Automap"
       pool: "web_pool"
       policies: web-policy
       all_profiles:
         - "http"
         - "clientssl"
     delegate_to: localhost



